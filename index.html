<!-- template.html -->
<html>
  <head>
    <title>JSHanabi</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script src="react"></script>
    <script src="JSXTransformer"></script>
    <script src="jquery"></script>
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
    <div id="main">
      <div id="start">
        <button disabled="true" class="button">Start Game</button>
      </div>
      <div id="players"></div>
      <div id="chat"></div>
    </div>
    <script type="text/jsx">
      /** @jsx React.DOM */
      // The above declaration must remain intact at the top of the script.

      var startGame = function() {
        console.log("TODO: Start the game");
      };

      var socket = io("http://localhost:3001");

      var Status = React.createClass({
        render: function() {
          if(this.props.connected) {
            return <div>There are currently {this.props.players} players connected.</div>
          } else {
            return <div>Server is down. I repeat: The server is down! Panic is advisable!</div>
          }
        }
      });

      var PlayerList = React.createClass({
        render: function() {
          var createPlayer = function(player) {
            return <li key={player.id}>{player.name}</li>
          };
          return <ul>{this.props.players.map(createPlayer)}</ul>
        }
      });

      var Chat = React.createClass({
        getInitialState: function() {
          socket.on('chat', function(message) {
            var messages = this.state.messages;
            messages.push(message);
            this.setState({messages: messages});
            // Scroll to bottom to see the new message
            var wrapper = document.getElementsByClassName("overflow-wrapper")[0];
            wrapper.scrollTop = wrapper.scrollHeight;
          }.bind(this));
          return {message: "", messages: []}
        },
        show: function(message) {
          return [<dt>{message.name}</dt>,
                  <dd>{message.text}</dd>]
        },
        emitMessage: function(e) {
          e.preventDefault();
          var message = this.state.message;
          socket.emit('chat', message); 
          this.setState({message: ''});
        },
        onChange: function(e) {
          var message = e.target.value;
          this.setState({message: message});
        },
        render: function() {
          return (
            <div className='chat'>
              <div className='overflow-wrapper'>
                <dl>{this.state.messages.map(this.show)}</dl>
              </div>
              <form onSubmit={this.emitMessage}>
                <input id='chat-message' onChange={this.onChange} value={this.state.message} />
                <button className='button send' disabled='true'>Send</button>
              </form>
            </div>
          )
        }
      });

      var HaNaNabi = React.createClass({
        getInitialState: function() {
          socket.on('disconnect', function () {
            this.setState({players: [], connected: false});
          }.bind(this));
          socket.on('connect', function () {
            this.setState({connected: true});
          }.bind(this));
          socket.on("allPlayers", function(data) {
            this.setState({
              players: data, 
              disabled: {join: this.state.disabled.join}
            });
            this.checkStart();
          }.bind(this));
          return {players: [], disabled: {join: true, start: true}};
        },

        checkStart: function() {
          var players = this.state.players.length;
          if(players < 2 || players > 5) {
              $('#start button').attr('disabled');
          } else {
              $('#start button').removeAttr('disabled');
          }
        },

        onChange: function(e) {
          var name = e.target.value;
          this.setState({name: name, disabled: {start: this.state.disabled.start, join: (name === "") }});
        },

        handleSubmit: function(e) {
          e.preventDefault();
          name = this.state.name;
          socket.emit("join", this.state.name);
          $('form.name button').attr('disabled', 'true');
          $('button.send').removeAttr('disabled');
          this.checkStart();
        },

        render: function() {
          return (
            <div>
              <Status connected={this.state.connected} players={this.state.players.length} />
              <PlayerList players={this.state.players} />
              <form className='name' onSubmit={this.handleSubmit}>
                <input onChange={this.onChange} value={this.state.name} />
                <button className='button' disabled={this.state.disabled.join}>Join game</button>
              </form>
            </div>
          );
        }
      
      });

      React.renderComponent(<HaNaNabi />, document.getElementById('players'));
      React.renderComponent(<Chat />, document.getElementById('chat'));
    </script>
  </body>
</html>
