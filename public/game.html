<!-- template.html -->
<html>
  <head>
    <title>JSHanabi</title>
    <link rel="stylesheet" type="text/css" href="css/styles.css">
    <script src="js/react.js"></script>
    <script src="js/JSXTransformer.js"></script>
    <script src="js/jquery-1.11.1.js"></script>
    <script src="http://underscorejs.org/underscore-min.js"></script>
    <script src="socket.io.js"></script>
  </head>
  <body>
    <div id="main"></div>
    <script type="text/jsx" src="js/chat.jsx"></script>
    <script type="text/jsx">
      /** @jsx React.DOM */
      // The above declaration must remain intact at the top of the script.

      var app = app || {};
      var Chat = app.Chat;

      var gameID = location.search.split('=')[1];
      var socket = io(":3001/" + gameID);

      var state
      var yourPlayerNum = 0

      var VisCard = React.createClass({
        showDialog: function(recipient, suit, number) {
          if (state.whoseTurn != yourPlayerNum)
            return

          if (document.getElementById('playOrDiscardWindow').open)
            document.getElementById('playOrDiscardWindow').close()

          var dialog = document.getElementById('clueWindow')
          dialog.show();

          document.getElementById('giveClueAboutSuit').onclick = function() {
            socket.emit('clue', JSON.stringify({
              giver: yourPlayerNum,
              recipient: recipient,
              suitOrNumber: suit
            }))
            dialog.close()
          }

          document.getElementById('giveClueAboutNumber').onclick = function() {
            socket.emit('clue', JSON.stringify({
              giver: yourPlayerNum,
              recipient: recipient,
              suitOrNumber: number
            }))
            dialog.close()
          }

          document.getElementById('cancelClueWindow').onclick = function() { dialog.close() }
        },

        render: function() {
          return (
            <div className="cardContainer">
              <button className={suitToCardClass(this.props.suit)} 
                      onClick={function() {
                        this.showDialog(this.props.playerNum, this.props.suit, this.props.number)
                      }.bind(this)}>
                {this.props.number}
              </button>
            </div>
          )
        }
      })

      var InvisCard = React.createClass({
        showDialog: function(cardIndex) {
          if (state.whoseTurn != yourPlayerNum)
            return

          if (document.getElementById('clueWindow').open)
            document.getElementById('clueWindow').close()

          var dialog = document.getElementById('playOrDiscardWindow')
          dialog.show();

          document.getElementById('playCard').onclick = function() {
            socket.emit('playCard', JSON.stringify({
              player: yourPlayerNum,
              cardIndex: cardIndex
            }))
            dialog.close()
          }

          document.getElementById('discard').onclick = function() {
            socket.emit('discard', JSON.stringify({
              player: yourPlayerNum,
              cardIndex: cardIndex
            }))
            dialog.close()
          }

          document.getElementById('cancelPDWindow').onclick = function() { dialog.close() }
        },

        renderCard: function(card) {
          return <invisCard suit={card.suit} number={card.number}/>
        },

        render: function() {
          return (
            <div className="cardContainer">
              <button className="invisCard" onClick={function(){ this.showDialog(this.props.key) }.bind(this)}>?</button>
            </div>
          )
        }
      })

      var TeamPiles = React.createClass({
        renderCard: function(card) {
          return <VisCard suit={card.suit} number={card.number}/>
        },
        render: function() {
          var dummies = [{number: "_", suit: "blue"},
                         {number: "_", suit: "red"},
                         {number: "_", suit: "green"},
                         {number: "_", suit: "white"},
                         {number: "_", suit: "yellow"}];
          this.props.cards.forEach(function(card) {
            dummies.forEach(function(dummy) {
              if(dummy.suit == card.suit) {
                dummy.number = card.number;
              }
            })
          });
          return(<div id="team-pile" className="cards">{dummies.map(this.renderCard)}</div>)
        }
      })

      var Discards = React.createClass({
        renderCard: function(card) {
          return <VisCard suit={card.suit} number={card.number}/>
        },
        render: function() {
          return(<div className="cards discards">{this.props.cards.map(this.renderCard)}</div>
          )
        }       
      })
      
      var MyHand = React.createClass({
        render: function() {
          var cards = []
          for (var c = 0; c < this.props.yourCards; c++)
            cards.push(<InvisCard key={c}/>)

          return(
            <tr>
              <td className="text">{this.props.name}</td>
              <td className="cards hand">{cards}</td>
            </tr>
          )
        }
      })

      var OtherHand = React.createClass({
        renderCards: function() {
          var cards = []
          for (var c = 0; c < this.props.cards.length; c++) {
            var card = this.props.cards[c]
            cards.push(<VisCard suit={card.suit} number={card.number} playerNum={this.props.playerNum}/>)
          }
          return cards
        },

        render: function() {
          return(
            <tr>
              <td className="text">{this.props.name}</td>
              <td className="cards hand">{this.renderCards()}</td>
            </tr>
          )
        }
      })

      // <VisCard suit={card.suit} Number={card.Number} key={cardKey}/>

      function suitToCardClass(suitName) {
        return suitName + 'card'
      }

      var OtherPlayers = React.createClass({
        makeHands: function(listOfHands) {
          var hands = []
          for (var h = 0; h < listOfHands.length; h++) {
            if (listOfHands[h])
              hands.push(<OtherHand cards={listOfHands[h]} playerNum={h} name={this.props.names[h]}/>)
          }
          return hands
        },

        render: function() {
          return <div>{this.makeHands(this.props.hands)}</div>
        }
      })

      var CluesLivesDeck = React.createClass({
        render: function() {
          return(
            <div className="cluesLivesDeck">
              <div>Deck: {this.props.deckLength} cards left</div>
              <div>Clues: {this.props.clues}</div>
              <div>Lives: {this.props.lives}</div>
            </div>
          )
        }
      })

      var WholeGame = React.createClass({
        getInitialState: function() {

          socket.on('connect', function() {
            this.setState({text: "Connect"});
          }.bind(this))

          socket.on('gameState', this.gameState)
          socket.on('players', this.setNames)
          socket.on('erra', this.showError)
          socket.on('clue', function(clue) {
            clue = JSON.parse(clue);
            clue.giver = this.state.names[clue.giver];
            clue.recipient = this.state.names[clue.recipient];
            this.refs.chat.showClue(clue);
          }.bind(this));
          socket.on('move', function(move) {
            move = JSON.parse(move)
            move.player = this.state.names[move.player];
            this.refs.chat.showMove(move);
          }.bind(this));

          state = {hands: [[0]],
                  teamPiles: [],
                  discards: [],
                  yourPlayerNum: 0,
                  names: ['No Name']}

          return state
        },

        showError: function(message) {
          this.refs.chat.flushMessage({name: 'Hanubi', text: message});
        },

        setNames: function(names) {
          var playerNames = [];
          names.forEach(function(nameObj) {
            playerNames[nameObj.id] = nameObj.name;
          });
          this.setState({names: playerNames});
        },

        gameState: function(game) {
          yourPlayerNum = game.youAre
          state = game
          this.setState(state)
        },

        render: function() {
          var names = this.state.names.slice();
          var yourName = names.splice(yourPlayerNum, 1, undefined)[0];
          return(
            <div id="game">
              <div id="cards">
                <TeamPiles cards={this.state.teamPiles}/>
                <Discards cards={this.state.discards}/>
                <table>
                  <OtherPlayers hands={this.state.hands} names={names}/>
                  <MyHand yourCards={this.state.yourCards} name={yourName}/>
                </table>
                <CluesLivesDeck deckLength={this.state.deckLength} clues={this.state.clues} lives={this.state.lives}/>
              </div>
              <Chat socket={socket} ref="chat" />
            </div>
          )
        }
      })

      React.renderComponent(
        <WholeGame />,
        document.getElementById('main')
      )


    </script>
    <dialog id="clueWindow" class="dialog">
      <button class="button" id="giveClueAboutSuit">Suit Clue</button>
      <button class="button" id="giveClueAboutNumber">Number Clue</button>
      <button class="button" id="cancelClueWindow">Cancel</button>
    </dialog>
    <dialog id="playOrDiscardWindow" class="dialog">
      <button class="button" id="playCard">Play Card</button>
      <button class="button" id="discard">Discard</button>
      <button class="button" id="cancelPDWindow">Cancel</button>
    </dialog>
  </body>
</html>
