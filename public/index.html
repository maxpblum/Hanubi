<!-- template.html -->
<html>
  <head>
    <title>JSHanabi</title>
    <link rel="stylesheet" type="text/css" href="css/styles.css">
    <script src="js/react.js"></script>
    <script src="js/JSXTransformer.js"></script>
    <script src="js/jquery-1.11.1.js"></script>
    <script src="socket.io.js"></script>
  </head>
  <body>
    <div id="main">
    </div>
    <script type="text/jsx">
      /** @jsx React.DOM */
      // The above declaration must remain intact at the top of the script.

      var startGame = function() {
        console.log("emitting startGame")
        socket.emit("startGame");
      };

      var socket = io(":3001");

      var Status = React.createClass({
        render: function() {
          if(this.props.connected) {
            return <div>There are currently {this.props.players} players connected.</div>
          } else {
            return <div>Server is down. I repeat: The server is down! Panic is advisable!</div>
          }
        }
      });

      var Start = React.createClass({
        render : function() {
          return (
            <div id="start">
              <button disabled={!this.props.enabled} onClick={startGame} className="button">Start Game</button>
            </div>
          )
        }
      });

      var PlayersList = React.createClass({
        getInitialState: function() {
          return {name: ""}
        },
        onChange: function(e) {
          this.setState({name: e.target.value});
        },
        handleSubmit: function(e) {
          e.preventDefault();
          socket.emit("join", this.state.name);
        },
        render: function() {
          var createPlayer = function(player) {
            return <li key={player.id}>{player.name}</li>
          };
          return (
            <div id="players">
              <Status connected={this.props.connected} players={this.props.players.length} />
              <ul>{this.props.players.map(createPlayer)}</ul>
              <form className='name' onSubmit={this.handleSubmit}>
                <input onChange={this.onChange} value={this.state.name} />
                <button className='button' disabled={!this.state.name}>Join game</button>
              </form>
            </div>
          )
        }
      });

      var Chat = React.createClass({
        getInitialState: function() {
          socket.on('chat', function(message) {
            var messages = this.state.messages;
            messages.push(message);
            this.setState({messages: messages});
            // Scroll to bottom to see the new message
            var wrapper = document.getElementsByClassName("overflow-wrapper")[0];
            wrapper.scrollTop = wrapper.scrollHeight;
          }.bind(this));
          return {message: "", messages: []}
        },
        show: function(message) {
          return [<dt>{message.name}</dt>,
                  <dd>{message.text}</dd>]
        },
        emitMessage: function(e) {
          e.preventDefault();
          var message = this.state.message;
          socket.emit('chat', message); 
          this.setState({message: ''});
        },
        onChange: function(e) {
          var message = e.target.value;
          this.setState({message: message});
        },
        render: function() {
          return (
            <div id='chat'>
              <div className='overflow-wrapper'>
                <dl>{this.state.messages.map(this.show)}</dl>
              </div>
              <form onSubmit={this.emitMessage}>
                <input id='chat-message' onChange={this.onChange} value={this.state.message} />
                <button className='button send' disabled={!this.props.joined}>Send</button>
              </form>
            </div>
          )
        }
      });

      var HaNaNabi = React.createClass({
        getInitialState: function() {
          socket.on('disconnect', function () {
            this.setState({players: [], connected: false, joined: false});
          }.bind(this));

          socket.on('connect', function () {
            this.setState({connected: true});
          }.bind(this));

          socket.on('joined', function() {
            console.log("Should set state joined to true");
            this.setState({joined: true});
          }.bind(this));

          socket.on('gameIsStarting', function() {
          console.log("Should redirect");
            window.location.href = '/game';
          });

          socket.on("allPlayers", function(data) {
            this.setState({players: data, start: data.length > 1 && data.length < 6});
          }.bind(this));
          
          // TODO change start state
          return {players: [], start: false, joined: false};
        },

        render: function() {
          return (
            <div>
              <Start enabled={this.state.start}/>,
              <PlayersList players={this.state.players} connected={this.state.connected} joined={this.state.joined} />,
              <Chat joined={this.state.joined} />
            </div>
          );
        }
      
      });

      React.renderComponent(<HaNaNabi />, document.getElementById('main'));
    </script>
  </body>
</html>
