<!-- template.html -->
<html>
  <head>
    <title>JSHanabi</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script src="react"></script>
    <script src="JSXTransformer"></script>
    <script src="jquery"></script>
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
    <div id="content"></div>
    <script type="text/jsx">
      /** @jsx React.DOM */
      // The above declaration must remain intact at the top of the script.

      var socket
      var state
      var nonGameState
      var yourPlayerNum = undefined

      var VisCard = React.createClass({
        showDialog: function(recipient, suit, number) {
          if (state.whoseTurn != yourPlayerNum)
            return

          console.log('your turn')

          if (document.getElementById('playOrDiscardWindow').open)
            document.getElementById('playOrDiscardWindow').close()

          var dialog = document.getElementById('clueWindow')
          dialog.show();

          document.getElementById('giveClueAboutSuit').onclick = function() {
            socket.emit('clue', JSON.stringify({
              giver: yourPlayerNum,
              recipient: recipient,
              suitOrNumber: suit
            }))
            dialog.close()
          }

          document.getElementById('giveClueAboutNumber').onclick = function() {
            socket.emit('clue', JSON.stringify({
              giver: yourPlayerNum,
              recipient: recipient,
              suitOrNumber: number
            }))
            dialog.close()
          }

          document.getElementById('cancelClueWindow').onclick = function() { dialog.close() }
        },

        render: function() {
          return (
            <div className="cardContainer">
              <button className={suitToCardClass(this.props.suit)} 
                      onClick={function() {
                        this.showDialog(this.props.playerNum, this.props.suit, this.props.number)
                      }.bind(this)}>
                {this.props.number}
              </button>
            </div>
          )
        }
      })

      var InvisCard = React.createClass({
        showDialog: function(cardIndex) {
          if (state.whoseTurn != yourPlayerNum)
            return

          if (document.getElementById('clueWindow').open)
            document.getElementById('clueWindow').close()

          var dialog = document.getElementById('playOrDiscardWindow')
          dialog.show();

          document.getElementById('playCard').onclick = function() {
            socket.emit('playCard', JSON.stringify({
              player: yourPlayerNum,
              cardIndex: cardIndex
            }))
            dialog.close()
          }

          document.getElementById('discard').onclick = function() {
            socket.emit('discard', JSON.stringify({
              player: yourPlayerNum,
              cardIndex: cardIndex
            }))
            dialog.close()
          }

          document.getElementById('cancelPDWindow').onclick = function() { dialog.close() }
        },

        renderCard: function(card) {
          return <invisCard suit={card.suit} number={card.number}/>
        },

        render: function() {
          return (
            <button className="invisCard" onClick={function(){ this.showDialog(3) }.bind(this)}>?</button>
          )
        }
      })

      var TeamPiles = React.createClass({
        renderCard: function(card) {
          return <VisCard suit={card.suit} number={card.number}/>
        },
        render: function() {
          return(
            <div className="teamPiles">
              Team Piles:
              {this.props.cards.map(this.renderCard)}
            </div>
          )
        }
      })

      var Discards = React.createClass({
        renderCard: function(card) {
          return <VisCard suit={card.suit} number={card.number}/>
        },
        render: function() {
          return(
            <div className="discards">
              Discards:
              {this.props.cards.map(this.renderCard)}
            </div>
          )
        }       
      })
      
      var MyHand = React.createClass({
        render: function() {
          var cards = []
          for (var c = 0; c < this.props.yourCards; c++)
            cards.push(<InvisCard />)

          return(
            <div className="myHand">
              My Hand:
              {cards}
            </div>
          )
        }
      })

      var OtherHand = React.createClass({
        renderCards: function() {
          var cards = []
          for (var c = 0; c < this.props.cards.length; c++) {
            var card = this.props.cards[c]
            cards.push(<VisCard suit={card.suit} number={card.number} playerNum={this.props.playerNum}/>)
          }
          return cards
        },

        render: function() {
          return(
            <div className="otherHand">
              Someone else's hand:
              {this.renderCards()}
            </div>
          )
        }
      })

      // <VisCard suit={card.suit} Number={card.Number} key={cardKey}/>

      function suitToCardClass(suitName) {
        return suitName + 'card'
      }

      var OtherPlayers = React.createClass({
        makeHands: function(listOfHands) {
          var hands = []
          for (var h = 0; h < listOfHands.length; h++) {
            var playerNum = h
            if (playerNum >= yourPlayerNum)
              playerNum++
            hands.push(<OtherHand cards={listOfHands[h]} playerNum={playerNum}/>)
          }
          return hands
        },

        render: function() {
          return(
            <div className="otherPlayers">
              {this.makeHands(this.props.hands)}
            </div>
          )
        }
      })

      var AllPlayers = React.createClass({
        render: function() {
          return(
            <div className="allPlayers">
              <OtherPlayers hands={this.props.hands}/>
              <MyHand yourCards={this.props.yourCards}/>
            </div>
          )
        }
      })

      var CluesLivesDeck = React.createClass({
        render: function() {
          return(
            <div className="cluesLivesDeck">
              <div>Deck: {this.props.deckLength} cards left</div>
              <div>Clues: {this.props.clues}</div>
              <div>Lives: {this.props.lives}</div>
            </div>
          )
        }
      })

      var GameText = React.createClass({
        render: function() {
          return(
            <div className="gameText">
              {this.props.text}
            </div>
          )
        }
      })

      var nonGame = React.createClass({
        joinNew: function () {
          if (socket)
            socket.emit('joinNew', '')
        },

        joinPaused: function(seatNum) {
          if (socket)
            socket.emit('joinPaused', seatNum)
        },

        render: function() {
          var youAreOne = 
            <span id="yourNewGameStatus">"You are one of them!"</span>

          var joinButton =
            <button id="joinNew" onClick={this.joinNew}>Join new game</button>

          var newGame = 
            <div className="newGame">
              <span id="playersWaiting">There are {nonGameState.playersWaiting} players waiting to start a new game.</span>
              {nonGameState.youveJoined ? youAreOne : joinButton}
            </div>

          var openSeatButtons = nonGameState.openSeats.map(function(seatNum) {
            return <button className="seatButton" onClick={function(){
              this.joinPaused(seatNum)
            }.bind(this)}>{seatNum}</button>
          })

          var openSeatDialog = 
            <div className="openSeatDialog">
              Here are the available seats:
              {openSeatButtons}
            </div>

          var gameIsPaused = <span id="pausedGame">The game is paused.</span>

          var pausedGame = yourPlayerNum ? gameIsPaused : openSeatDialog

          return(
            <div className="nonGameScreen">
              {this.props.gameExists ? pausedGame : newGame}
            </div>
          )
        }
      })

      var WholeGame = React.createClass({
        getInitialState: function() {

          socket = io()

          socket.on('connect', function() {
            this.setState({text: "Connect"});
          }.bind(this))

          socket.on('youAre', this.assignPlayerNum)

          socket.on('gameInit', this.gameInit)

          socket.on('nonGame', this.nonGameUpdate)

          socket.on('erra', this.showError)

          return nonGameState ? nonGameState : null
        },

        assignPlayerNum: function(numStr) {
          yourPlayerNum = parseInt(numStr)
          this.render()
        },

        showError: function(message) {
          this.setState({gameText: message})
        },

        nonGameUpdate: function(nonGame) {
          nonGameState = JSON.parse(nonGame)
          this.setState(nonGameState)
          state = {}
        },

        gameInit: function(game) { 
          nonGameState = {}
          state = JSON.parse(game)
          state.gameText = (state.whoseTurn === yourPlayerNum) ? "Your turn" : "Player " + state.whoseTurn + "'s turn"
          this.setState(state) 
        },

        render: function() {
          if (state){
            return(
              <div className="wholegame">
                <TeamPiles cards={this.state.teamPiles}/>
                <Discards cards={this.state.discards}/>
                <AllPlayers count={this.state.playerCount} hands={this.state.hands} yourCards={this.state.yourCards}/>
                <CluesLivesDeck deckLength={this.state.deckLength} clues={this.state.clues} lives={this.state.lives}/>
                <GameText text={this.state.gameText}/>
              </div>
            )
          } else if (nonGameState) {
            return <nonGame gameExists={nonGameState.paused} />
          } else {
            return <span id="nothingYet">No connection yet.</span>
          }

        }
      })

      React.renderComponent(
        <WholeGame />,
        document.getElementById('content')
      )


    </script><dialog id="clueWindow">
      <button id="giveClueAboutSuit">Suit Clue</button>
      <button id="giveClueAboutNumber">Number Clue</button>
      <button id="cancelClueWindow">x</button>
    </dialog>
    <dialog id="playOrDiscardWindow">
      <button id="playCard">Play Card</button>
      <button id="discard">Discard</button>
      <button id="cancelPDWindow">x</button>
    </dialog>
  </body>
</html>
